/**
 * Core Philosophy:
 * This ruleset enforces a security model with distinct roles for players and administrators.
 * Players have strict ownership over their personal data, while admins have broader
 * permissions to manage game data and moderate content like score submissions. Public data,
 * such as active games and approved high scores, is openly readable to facilitate the app's
 * primary function as a retro gaming event platform.
 *
 * Data Structure:
 * The data is organized into several top-level collections:
 * - /players/{playerId}: Stores private user profiles, keyed by the user's auth UID.
 * - /games/{gameId}: A publicly readable list of games available at the event.
 * - /scoreSubmissions/{scoreSubmissionId}: A mixed-access collection where approved scores
 *   are public, but pending/rejected scores are private to the submitter and admins.
 * - /admins/{adminId}: An access-control list where the existence of a document grants
 *   admin privileges to the corresponding user UID.
 *
 * Key Security Decisions:
 * - Admin Access: Administrative privileges are granted to a specific email address.
 *   This is a simple role-based access control (RBAC) pattern.
 * - Public Data: The `/games` collection and the `/appConfig/event` document are
 *   publicly readable to allow any user or client to fetch essential app information.
 * - Mixed-Access for Submissions: The `/scoreSubmissions` collection is publicly listable
 *   to support the main leaderboard query (for approved scores). However, direct reads (`get`)
 *   of individual documents are restricted to the owner, admins, or if the score is publicly
 *   approved, ensuring pending submissions remain private.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for reusable logic
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    function isAdmin() {
      // IMPORTANT: This rule grants admin access to a specific email address.
      // For this to work, you MUST create a user in your Firebase Authentication
      // console with the email 'viren@example.com'.
      return isSignedIn() && request.auth.token.email == 'viren@example.com';
    }

    /**
     * @description
     *   Manages player profiles. Each player's document is private and can only be
     *   created and modified by the authenticated user themselves. Admins can read
     *   all player data.
     * @path /players/{playerId}
     */
    match /players/{playerId} {
      allow get: if isOwner(playerId) || isAdmin();
      allow list: if isSignedIn() || isAdmin();
      allow create: if isSignedIn();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description
     *   Manages the list of available retro games. This data is public for all users to read,
     *   but only administrators can create, update, or delete game entries.
     * @path /games/{gameId}
     */
    match /games/{gameId} {
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description
     *   Stores player score submissions. Creating a submission is allowed for any signed-in
     *   user. Reads are conditional: public if 'approved', otherwise private to the owner
     *   and admins. Updates (moderation) and deletions are restricted to admins.
     * @path /scoreSubmissions/{scoreSubmissionId}
     */
    match /scoreSubmissions/{scoreSubmissionId} {
      // Admins have full read/write access.
      allow read, write: if isAdmin();

      // Players can create their own submissions.
      allow create: if isSignedIn();

      // All scores are public.
      allow get: if true;
      
      // Allow list queries for the leaderboard.
      allow list: if true;
    }

    /**
     * @description
     *   A role-based access collection. The existence of a document here grants admin
     *   privileges. This collection is locked down; only existing admins can view or
     *   manage the list of other admins.
     * @path /admins/{adminId}
     */
    match /admins/{adminId} {
      allow get, list: if isAdmin();
      allow create, update, delete: if isAdmin();
    }
  }
}
