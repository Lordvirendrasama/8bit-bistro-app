
/**
 * Core Philosophy:
 * This ruleset enforces a security model with distinct roles for players and administrators.
 * Players have strict ownership over their personal data, while admins have broader
 * permissions to manage game data and moderate content like score submissions. Public data,
 * such as active games and approved high scores, is openly readable to facilitate the app's
 * primary function as a retro gaming event platform.
 *
 * Data Structure:
 * The data is organized into several top-level collections:
 * - /players/{playerId}: Stores private user profiles, keyed by the user's auth UID.
 * - /games/{gameId}: A publicly readable list of games available at the event.
 * - /events/{eventId}: A publicly readable list of events.
 * - /scoreSubmissions/{scoreSubmissionId}: A mixed-access collection where approved scores
 *   are public, but pending/rejected scores are private to the submitter and admins.
 * - /admins/{adminId}: An access-control list where the existence of a document grants
 *   admin privileges to the corresponding user UID.
 *
 * Key Security Decisions:
 * - Admin Access: For development, all authenticated users are considered admins.
 * - Public Data: The `/games` and `/events` collections are publicly readable. Approved scores
 *   are also publicly readable.
 * - Score Submissions: Writing scores is limited to authenticated users.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for reusable logic
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAdmin() {
      // For development, all authenticated users are considered admins.
      return isSignedIn();
    }

    /**
     * @description
     *   Manages player profiles.
     * @path /players/{playerId}
     */
    match /players/{playerId} {
      allow get: if isOwner(playerId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isSignedIn();
      allow update, delete: if isAdmin();
    }

    /**
     * @description
     *   Manages the list of available retro games. Publicly readable.
     * @path /games/{gameId}
     */
    match /games/{gameId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /**
     * @description
     *   Manages the list of events. Publicly readable.
     * @path /events/{eventId}
     */
    match /events/{eventId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    /**
     * @description
     *   Stores player score submissions.
     * @path /scoreSubmissions/{scoreSubmissionId}
     */
    match /scoreSubmissions/{scoreSubmissionId} {
      allow read: if true;
      allow create: if isSignedIn();
      allow update, delete: if isAdmin();
    }

    /**
      * @description
      *   A role-based access collection for administrators.
      * @path /admins/{adminId}
      */
    match /admins/{adminId} {
      allow read, write: if isAdmin();
    }
  }
}
